apiVersion: apps/v1
kind: Deployment
metadata:
  name: dendrite
  namespace: zent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dendrite
  template:
    metadata:
      labels:
        app: dendrite
    spec:
      enableServiceLinks: false
      containers:
        - name: dendrite
          image: matrixdotorg/dendrite-monolith:latest
          ports:
            - containerPort: 8008
            - containerPort: 8448
          env:
            - name: DENDRITE_CONFIG
              value: /etc/dendrite/dendrite.yaml
          resources:
            requests:
              cpu: "100m"
              memory: "256Mi"
            limits:
              cpu: "500m"
              memory: "2Gi"
          volumeMounts:
            - name: dendrite-config
              mountPath: /etc/dendrite
            - name: dendrite-data
              mountPath: /var/dendrite
          livenessProbe:
            httpGet:
              path: /_matrix/client/versions
              port: 8008
            initialDelaySeconds: 30
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /_matrix/client/versions
              port: 8008
            initialDelaySeconds: 10
            periodSeconds: 5
      volumes:
        - name: dendrite-config
          configMap:
            name: dendrite-config
        - name: dendrite-data
          persistentVolumeClaim:
            claimName: dendrite-data
---
apiVersion: v1
kind: Service
metadata:
  name: dendrite
  namespace: zent
spec:
  selector:
    app: dendrite
  ports:
    - name: http
      port: 8008
      targetPort: 8008
    - name: https
      port: 8448
      targetPort: 8448
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dendrite-config
  namespace: zent
data:
  dendrite.yaml: |
    version: 2
    global:
      server_name: 3aka.com
      private_key: /var/dendrite/matrix_key.pem
      key_validity_period: 168h0m0s
      database:
        connection_string: file:/var/dendrite/dendrite.db
        max_open_conns: 50
        max_idle_conns: 5
      cache:
        max_size_estimated: 512mb
        max_age: 1h
      jetstream:
        storage_path: /var/dendrite/jetstream
        in_memory: false
    app_service_api:
      database:
        connection_string: file:/var/dendrite/dendrite-appservice.db
      config_files:
        - /etc/dendrite/appservice-zent.yaml
    client_api:
      registration_disabled: true
      rate_limiting:
        enabled: true
        threshold: 20
        cooloff_ms: 500
    federation_api:
      database:
        connection_string: file:/var/dendrite/dendrite-federation.db
    media_api:
      database:
        connection_string: file:/var/dendrite/dendrite-media.db
      base_path: /var/dendrite/media
      max_file_size_bytes: 52428800
    room_server:
      database:
        connection_string: file:/var/dendrite/dendrite-roomserver.db
    sync_api:
      database:
        connection_string: file:/var/dendrite/dendrite-syncapi.db
    user_api:
      database:
        connection_string: file:/var/dendrite/dendrite-userapi.db
    mscs:
      database:
        connection_string: file:/var/dendrite/dendrite-mscs.db
    logging:
      - type: std
        level: warn
  appservice-zent.yaml: |
    id: zent-bridge
    url: http://zent-matrix-bridge:4004
    as_token: zent-bridge-as-token-2026
    hs_token: zent-bridge-hs-token-2026
    sender_localpart: _zent_bot
    namespaces:
      users:
        - exclusive: true
          regex: "@_zent_.*"
      aliases:
        - exclusive: true
          regex: "#_zent_.*"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: zent-matrix-bridge
  namespace: zent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: zent-matrix-bridge
  template:
    metadata:
      labels:
        app: zent-matrix-bridge
    spec:
      enableServiceLinks: false
      containers:
        - name: bridge
          image: ghcr.io/akadon/zent-matrix-bridge:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 4004
          env:
            - name: BRIDGE_PORT
              value: "4004"
            - name: HOMESERVER_URL
              value: "http://dendrite:8008"
            - name: BRIDGE_DOMAIN
              value: "3aka.com"
            - name: HS_TOKEN
              value: "zent-bridge-hs-token-2026"
            - name: AS_TOKEN
              value: "zent-bridge-as-token-2026"
            - name: REDIS_URL
              valueFrom:
                configMapKeyRef:
                  name: zent-config
                  key: REDIS_URL
          resources:
            requests:
              cpu: "50m"
              memory: "64Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
          livenessProbe:
            httpGet:
              path: /health
              port: 4004
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health
              port: 4004
            initialDelaySeconds: 5
            periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: zent-matrix-bridge
  namespace: zent
spec:
  selector:
    app: zent-matrix-bridge
  ports:
    - port: 4004
      targetPort: 4004
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: dendrite-data
  namespace: zent
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
